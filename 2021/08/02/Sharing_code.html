<script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script>
<script type="text/x-mathjax-config">
   MathJax.Hub.Config({
     tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"] ],
       processEscapes: true
     }
   });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>


<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Documentation and testing</h1><p class="post-meta post-meta-title">
    </p>

    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In the course so far you have learnt the building blocks of Python. With this you can write a surprising amount of useful code! However our efforts are rewarded many times over if we can share the code we have written. Sharing your code:</p>
<ul>
  <li>clearly demonstrates your programming skills to future employers and/or supervisors</li>
  <li>enables other researchers to use your code, progressing science forwards</li>
  <li>establishes you an active participant in a particular domain or community of practice (people <em>know who you are</em>)</li>
</ul>

<p>However it is unfortunately not enough to stick our Python scripts / modules online and hope that other people will use them. We need to use tests to demonstrate that our software is reliable, and we need to write documentation so that others understand how best to use the code. These two topics - testing and documentation - are the focus of this lesson.</p>

<p>Please note that the following text has been closeley adapted, with permission, from the <a href="https://coderefinery.github.io/testing/motivation/">Code Refinery software testing lesson</a> and the <a href="https://coderefinery.github.io/documentation/">Code Refinery documentation lesson</a>.</p>

<h3 id="untested-software-can-be-compared-to-uncalibrated-detectors">Untested software can be compared to uncalibrated detectors</h3>

<blockquote>
  <p>“Before relying on a new experimental device, an experimental scientist always establishes its accuracy. A new detector is calibrated when the scientist observes &gt; its responses to known input signals. The results of this calibration are compared against the expected response.”</p>
</blockquote>

<p>[From <a href="https://carpentries-incubator.github.io/python-testing/">Testing and Continuous Integration with Python</a>, created by K. Huff]</p>

<p>Simulations and analysis using software should be held to the same standards as experimental measurement devices!</p>

<p>Further motivation for testing:</p>
<ul>
  <li><a href="https://science.sciencemag.org/content/314/5807/1856.summary">A Scientist’s Nightmare: Software Problem Leads to Five Retractions</a></li>
  <li><a href="https://arstechnica.com/information-technology/2019/10/chemists-discover-cross-platform-python-scripts-not-so-cross-platform/">Researchers find bug in Python script may have affected hundreds of studies</a></li>
</ul>

<h3 id="testing-helps-to-detect-errors-before-they-cause-problems">Testing helps to detect errors before they cause problems</h3>

<p>In software tests, expected results are compared with observed results in order to establish accuracy:</p>
<ul>
  <li>As projects grow, it becomes easier to break things without noticing immediately</li>
  <li>Software defects can be caused by both human errors and non-controllable events (i.e. environmental conditions)</li>
  <li>Testing is essential for research software because we care about reproducibility of scientific results</li>
</ul>

<p>Testing also encourages others to use your code:</p>
<ul>
  <li>It provides a way for users to see if the code is installed correctly</li>
  <li>It allows users to better judge the quality of the code</li>
</ul>

<p>Finally, testing encourages other developers to contribute to your code as it is easier for external developers to contribute to the project without breaking your code (or at least it is clear when they have broken the code!)</p>

<p>However bear in mind that tested code does not mean the code is <em>perfect</em>; “Program testing can be used to show the presence of bugs, but never to show their absence!” (Edsger W. Dijkstra)</p>

<p><strong>Discussion question:</strong> Can you think of examples where it is <em>not</em> necessary to share your code?</p>

<details>
  <summary>Show answer</summary>

  <p>Some examples where you may choose not to test your code:</p>
  <ul>
    <li>A Jupyter notebook which produces a plot and you know by looking at the plot whether it worked</li>
    <li>A short, ‘obviously correct’ Python script which you never intend to reuse</li>
  </ul>

</details>

<h3 id="use-assertions-for-things-you-believe-willshould-never-happen">Use assertions for things you believe will/should never happen.</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">kelvin_to_celsius</span><span class="p">(</span><span class="n">temp_k</span><span class="p">):</span>
    <span class="s">"""
    Converts temperature in Kelvin
    to Celsius.
    """</span>
    <span class="k">assert</span> <span class="n">temp_k</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">"ERROR: negative T_K"</span>
    <span class="n">temp_c</span> <span class="o">=</span> <span class="n">temp_k</span> <span class="o">-</span> <span class="mf">273.15</span>
    <span class="k">return</span> <span class="n">temp_c</span>
</code></pre></div></div>

<h3 id="units-testing-is-for-small-components-units-of-a-code">Units testing is for small components (units) of a code</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fahrenheit_to_celsius</span><span class="p">(</span><span class="n">temp_f</span><span class="p">):</span>
    <span class="s">"""Converts temperature in Fahrenheit
    to Celsius.
    """</span>
    <span class="n">temp_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_f</span> <span class="o">-</span> <span class="mf">32.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">9.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">temp_c</span>

<span class="c1"># This is the test function: `assert` raises an error if something
# is wrong.
</span><span class="k">def</span> <span class="nf">test_fahrenheit_to_celsius</span><span class="p">():</span>
    <span class="n">temp_c</span> <span class="o">=</span> <span class="n">fahrenheit_to_celsius</span><span class="p">(</span><span class="n">temp_f</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span>
    <span class="n">expected_result</span> <span class="o">=</span> <span class="mf">37.777777</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">temp_c</span> <span class="o">-</span> <span class="n">expected_result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-6</span>
</code></pre></div></div>

<ul>
  <li>Unit tests are functions</li>
  <li>Unit testing is used to test one unit: for example, a single function</li>
</ul>

<p><strong>Question:</strong> In the example above we want to check if the calculated <code class="language-plaintext highlighter-rouge">temp_c</code> is equal to the <code class="language-plaintext highlighter-rouge">expected_result</code>. Why do we use the assert statement <code class="language-plaintext highlighter-rouge">abs(temp_c - expected_result) &lt; 1.0e-6</code> instead of the simpler assert statement <code class="language-plaintext highlighter-rouge">temp_c == expected_result</code>?</p>

<details>
  <summary>Show answer</summary>

  <p>Due to the inherent limitations to computational accuracy, we should not test for the exact equality between two floats. Instead we check that they are the same to within a numerical tolerance (in this case 1.0e-6). For more details please see the lesson <a href="https://nu-cem.github.io/CompPhys/2021/08/02/Evaluating-Accuracy">Evaluating numerical errors and accuracy</a>.</p>

</details>

<p>Another commonly used type of testing is called <strong>end-to-end</strong>. End-to-end tests check if the software is working as a whole, from beginning to end. For example, you input example data at the start of a simulation and then check that the end results of the simulation are correct.</p>

<h3 id="pytest-can-be-used-to-implement-a-python-test-suite">Pytest can be used to implement a Python test suite</h3>

<p>Rather than running unit tests one-by-one we can use <a href="http://pytest.org/">pytest</a> to automatically find and run all the tests within a project; pytest collects and runs all test functions starting with test_.</p>

<p>In the following steps we will make a simple Python function and use pytest to test it.</p>

<ol>
  <li>Create a new directory and change into it:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>pytest-example
<span class="nb">cd </span>pytest-example
</code></pre></div></div>

<ol>
  <li>Then create a file called example.py and copy-paste the following code into it:</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">test_add</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="s">'space'</span><span class="p">,</span> <span class="s">'ship'</span><span class="p">)</span> <span class="o">==</span> <span class="s">'spaceship'</span>
</code></pre></div></div>

<p>This code contains one genuine function and a test function. pytest finds any functions beginning with test_ and treats them as tests.</p>

<ol>
  <li>Let us try to test it with pytest:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest <span class="nt">-v</span> example.py
</code></pre></div></div>

<pre><code class="language-output">============================================================ test session starts =================================
platform linux -- Python 3.7.2, pytest-4.3.1, py-1.8.0, pluggy-0.9.0 -- /home/user/pytest-example/venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/user/pytest-example, inifile:
collected 1 item

example.py::test_add PASSED

========================================================= 1 passed in 0.01 seconds ===============================
</code></pre>

<p>Yay! The test passed!</p>

<ol>
  <li>Let us break the test! Introduce a code change which breaks the code and check whether pytest detects the change:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest <span class="nt">-v</span> example.py
</code></pre></div></div>

<pre><code class="language-output">============================================================ test session starts =================================
platform linux -- Python 3.7.2, pytest-4.3.1, py-1.8.0, pluggy-0.9.0 -- /home/user/pytest-example/venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/user/pytest-example, inifile:
collected 1 item

example.py::test_add FAILED

================================================================= FAILURES =======================================
_________________________________________________________________ test_add _______________________________________

    def test_add():
&gt;       assert add(2, 3) == 5
E       assert -1 == 5
E         --1
E         +5

example.py:6: AssertionError
========================================================= 1 failed in 0.05 seconds ==============
</code></pre>

<p>Notice how pytest is smart and includes context: lines that failed, values of the relevant variables.</p>

<p><strong>Question:</strong> In the example above we have compared integers. In this optional exercise we want to learn how to compare floating point numbers since they are more tricky.</p>

<p>The following test will fail and this might be surprising. Try it out:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">test_add</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.3</span>
</code></pre></div></div>

<p>Your goal: find a more robust way to test this addition.</p>

<details>
  <summary>Show answer</summary>

  <p>One solution is to use <code class="language-plaintext highlighter-rouge">pytest.approx</code>:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">approx</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">test_add</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">add</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
</code></pre></div>  </div>

  <p>But maybe you didn’t know about pytest.approx: and did this instead:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_add</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-7</span>
</code></pre></div>  </div>

  <p>This is OK but the 1.0e-7 can be a bit arbitrary.</p>

</details>

<h3 id="documentation-comes-in-different-forms">Documentation comes in different forms</h3>

<blockquote>
  <p>There is nothing in the programming field more despicable than an undocumented program. 
  — Ed Yourdon, Software Engineering pioneer</p>
</blockquote>

<ul>
  <li>Tutorials: learning-oriented, allows the newcomer to get started</li>
  <li>How-to guides: goal-oriented, shows how to solve a specific problem</li>
  <li>Explanation: understanding-oriented, explains a concept</li>
  <li>Reference: information-oriented, describes the machinery</li>
</ul>

<p>These are distinct. For an excellent discussion, please see <a href="https://documentation.divio.com/">What nobody tells you about documentation</a>.</p>

<p>There is no one size fits all: however a good starting point is almost always to include a <code class="language-plaintext highlighter-rouge">README</code> file with your code. Your code may, depending on the number of users apart from yourself, also include:</p>

<ul>
  <li>Purpose</li>
  <li>Authors</li>
  <li>License</li>
  <li>Recommended citation</li>
  <li>Copy-paste-able example to get started</li>
  <li>Dependencies and their versions or version ranges</li>
  <li>Installation instructions</li>
  <li>Tutorials covering key functionality</li>
  <li>Reference documentation (e.g. API) covering all functionality</li>
  <li>How do you want to be asked questions (mailing list or forum or chat or issue tracker)</li>
  <li>FAQ section</li>
  <li>Contribution guide</li>
</ul>

<p><strong>Question:</strong> Visit the Github repository for <a href="https://github.com/lucydot/effmass/">effmass</a> and explore the repository and documentation site.</p>

<ol>
  <li>Which different types (tutorials/how-to/explanation/reference) of documentation can you find?</li>
  <li>Are all the items in the bullet point list included?</li>
</ol>

<details>
  <summary>Show answer</summary>
  <ol>
    <li>
      <ul>
        <li>There is a <a href="https://github.com/lucydot/effmass/">README file</a> with basic installation how-to instructions and an overview of the functionality.</li>
        <li>There are <a href="https://nbviewer.org/github/lucydot/effmass/blob/master/Tutorial.ipynb">notebook tutorials</a> for allowing newcomers to get started.</li>
        <li>There is API reference information <a href="https://effmass.readthedocs.io/en/latest/API%20documentation.html">here</a> which describes how each function works.</li>
        <li>There is a <a href="https://arxiv.org/pdf/1811.02281.pdf">paper</a> which explains some of the concepts behind the code (for example the different definitions of effective mass).</li>
      </ul>
    </li>
    <li>All of the bullet points on the list are included except i) there is no FAQ ii) the example is a Jupyter notebook and is not quickly copy-pastable (you would end up with the code and the surrounding text, which would then need to be removed).</li>
  </ol>

</details>

<h3 id="the-readme-file-is-important-for-users">The README file is important for users</h3>

<ul>
  <li>The README file is important as it is usually the first thing people look at when visiting a code repository.</li>
  <li>Use it to communitcate important information about your project.</li>
  <li>Write your README using a markup language such as Markdown. Github will automatically format your markdown file when you push it to your Github repository.</li>
  <li>The README should be in the top-level of your repository</li>
  <li>To make your README extra friendly you can use emojis.</li>
  <li>A README file might contains: A summary of the software purpose, author list, a link to the license file, a recommended citation, installation instructions and a list of code dependencies (e.g. numpy, matplotlib), a link to the issues tracker, and any other contact details.</li>
</ul>

<h3 id="in-code-documentation-is-important-for-code-developers">In-code documentation is important for code developers</h3>

<ul>
  <li>In-code documentation are very useful for people wanting to contribute to your code.</li>
  <li>They can also be used to auto-generate online documentation for functions/classes (for more information see the extension task below).</li>
  <li>The most commonly used Python in-code documentation are comments starting with <code class="language-plaintext highlighter-rouge">#</code> and Python docstrings</li>
</ul>

<p><strong>Question:</strong> Which of the comments below is the best and why?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Now we check if temperature is larger then -50:
</span><span class="k">if</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'do something'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We regard temperatures below -50 degrees as measurement errors
</span><span class="k">if</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">50</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'do something'</span><span class="p">)</span>
</code></pre></div></div>

<details>
  <summary>Show answer</summary>

  <p>The first comment describes what happens in this piece of code, whereas the second describes why this piece of code is there, i.e. its purpose. Comments like the second comment are much more useful.</p>

</details>

<h3 id="a-docstring-is-a-structured-comment-associated-to-a-segment-of-code-ie-a-function-or-class">A docstring is a structured comment associated to a segment of code (i.e. a function or class).</h3>

<p>We have already written basic docstrings. Here we will see how to write <a href="https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html">Google style docstrings</a>. Let’s look at the following function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mean_temperature</span><span class="p">(</span><span class="n">temperatures</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
</code></pre></div></div>

<p>We can make it clearer what this function does and how to use it using a docstring. A good docstring describes:</p>

<ul>
  <li>What the function does</li>
  <li>What goes in (including the type of the input variables)</li>
  <li>What goes out (including the return type)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">mean_temperature</span><span class="p">(</span><span class="n">temperatures</span><span class="p">):</span>
    <span class="s">"""
      Get the mean temperature

      Args:
          data (list): A list with air temperature measurements.

      Returns:
          The mean air temperature (float)
    """</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
</code></pre></div></div>

<p>Two key advantages of docstrings are:</p>
<ul>
  <li>Python parses docstrings, for example calling the <code class="language-plaintext highlighter-rouge">help</code> function will display the docstring: try <code class="language-plaintext highlighter-rouge">help(mean_temperature)</code></li>
  <li>You can generate your documentation as you are generating the code. In fact, thinking carefully about what the input/output/behaviour should be may encourage you to write better code!</li>
</ul>

<h3 id="tasks">TASKS</h3>

<ol>
  <li>
    <p>Write and run a unit test for the <code class="language-plaintext highlighter-rouge">Lorenz()</code> function in the <code class="language-plaintext highlighter-rouge">Lorenz.py</code> script you developed in <a href="https://nu-cem.github.io/CompPhys/2021/08/02/Scripting.html">a previous lesson</a>.</p>
  </li>
  <li>
    <p>Write a docstring for the <code class="language-plaintext highlighter-rouge">Lorenz()</code> function in the <code class="language-plaintext highlighter-rouge">Lorenz.py</code> script. Follow the <a href="https://github.com/google/styleguide/blob/gh-pages/pyguide.md#383-functions-and-methods">Google docstring format</a> as in the example above.</p>
  </li>
  <li>
    <p>Upload your new file to the remote Github repository you created in the <a href="https://nu-cem.github.io/CompPhys/2021/08/02/Version_control.html">previous lesson</a>.</p>
  </li>
</ol>

<h3 id="extension-tasks-automate-everything">EXTENSION TASKS: Automate everything!</h3>

<ol>
  <li>
    <p>Automated testing using Continuous Integration allows us to automatically run tests when there is a commit to a Github repository. Following the tutorial from <a href="https://coderefinery.github.io/testing/continuous-integration/">The Code Refinery</a>, implement continuous integration for a Github repository holding <code class="language-plaintext highlighter-rouge">Lorenz.py</code> (this could be the Github repository you created in the <a href="https://nu-cem.github.io/CompPhys/2021/08/02/Version_control.html">previous lesson</a>). Note that you will have to adapt the workflow file so that pip installs the python packages imported in your script (for Lorenz.py the packages are numpy and matplotlib).</p>
  </li>
  <li>
    <p>API (Application Programming Interface) documentation can be automatically generated using a tool such as <a href="https://pdoc3.github.io/pdoc/">pdoc3</a>. These tools read in all of the docstrings within a Python package and generate a webpage accordingly. For example, see the API documentation for the <a href="https://effmass.readthedocs.io/en/latest/inputs.html">effmass project</a>. Automatic API documentation is a real gamechanger; as long as we write update the docstrings alongside our code, we can quickly generate new documentation. Following the documentation on <a href="https://pdoc3.github.io/pdoc/">pdoc3</a> generate a html page with the API documentation for Lorenz.py. In the next lesson you will learn how to host this page using Github Pages.</p>
  </li>
</ol>

  </div><a class="u-url" href="/CompPhys/2021/08/02/Sharing_code.html" hidden></a>
</article>
